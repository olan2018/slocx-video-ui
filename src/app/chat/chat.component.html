<div class="meet-root">
  <!-- Top bar -->
  <div class="meet-topbar">
    <div class="meet-topbar-left">
      <img src="../../assets/slocx.png" class="meet-logo" alt="Slocx" />
      <span class="meet-brand">Slocx Classroom</span>
    </div>
    <div class="meet-topbar-right">
      <span class="meet-clock">{{ currentTime | date:'HH:mm' }}</span>
    </div>
  </div>

  <!-- Main area -->
  <div class="meet-main">
    <!-- Permission denied -->
    <div class="meet-state" *ngIf="permissionError">
      <div class="meet-state-icon meet-state-icon--error">
        <i class="bi bi-camera-video-off-fill"></i>
      </div>
      <p class="meet-state-title">Camera or microphone access denied</p>
      <p class="meet-state-sub">Please allow camera and microphone access in your browser settings, then refresh the page.</p>
    </div>

    <!-- Connection / room error -->
    <div class="meet-state" *ngIf="connectionError && !permissionError">
      <div class="meet-state-icon meet-state-icon--error">
        <i class="bi bi-wifi-off"></i>
      </div>
      <p class="meet-state-title">Unable to join classroom</p>
      <p class="meet-state-sub">{{ connectionErrorMsg }}</p>
    </div>

    <!-- Waiting for others -->
    <div class="meet-state" *ngIf="!permissionError && !connectionError && remoteCount === 0">
      <div class="meet-state-icon">
        <i class="bi bi-person-circle"></i>
      </div>
      <p class="meet-state-title">You're the only one here</p>
      <p class="meet-state-sub">Waiting for others to join the lesson...</p>
    </div>

    <!-- Remote video grid -->
    <div class="meet-video-grid" #videos [class.has-remotes]="remoteCount > 0"></div>

    <!-- Audio blocked prompt -->
    <div class="audio-prompt" *ngIf="showAudioPrompt" (click)="enableAudio()">
      <i class="bi bi-volume-mute-fill"></i>
      <span>Tap to enable audio</span>
    </div>

    <!-- Local video PiP -->
    <div class="meet-pip" *ngIf="!permissionError">
      <video #localVideo autoplay muted playsinline></video>
      <div class="meet-pip-overlay">
        <span class="meet-name-tag">You</span>
        <div class="meet-pip-badges">
          <span *ngIf="handRaised" class="pip-hand-badge">âœ‹</span>
          <i class="bi bi-mic-mute-fill" *ngIf="isMuted" style="color:#ea4335"></i>
          <i class="bi bi-camera-video-off-fill" *ngIf="!isCameraOn" style="color:#ea4335; margin-left:4px"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom control bar -->
  <div class="meet-controls">
    <div class="meet-controls-inner">
      <!-- Mic -->
      <button
        class="meet-ctrl-btn"
        [class.meet-ctrl-off]="isMuted"
        (click)="toggleMic()"
        [title]="isMuted ? 'Unmute microphone' : 'Mute microphone'"
      >
        <i class="bi" [class.bi-mic-fill]="!isMuted" [class.bi-mic-mute-fill]="isMuted"></i>
        <span class="meet-ctrl-label">{{ isMuted ? 'Unmute' : 'Mute' }}</span>
      </button>

      <!-- Camera -->
      <button
        class="meet-ctrl-btn"
        [class.meet-ctrl-off]="!isCameraOn"
        (click)="toggleCamera()"
        [title]="isCameraOn ? 'Turn off camera' : 'Turn on camera'"
      >
        <i class="bi" [class.bi-camera-video-fill]="isCameraOn" [class.bi-camera-video-off-fill]="!isCameraOn"></i>
        <span class="meet-ctrl-label">{{ isCameraOn ? 'Stop video' : 'Start video' }}</span>
      </button>

      <!-- Screen share -->
      <button
        class="meet-ctrl-btn"
        [class.meet-ctrl-active]="isScreenSharing"
        (click)="toggleScreenShare()"
        [title]="isScreenSharing ? 'Stop sharing' : 'Share screen'"
      >
        <i class="bi bi-display"></i>
        <span class="meet-ctrl-label">{{ isScreenSharing ? 'Stop share' : 'Share' }}</span>
      </button>

      <!-- Raise hand -->
      <button
        class="meet-ctrl-btn"
        [class.meet-ctrl-hand]="handRaised"
        (click)="toggleHand()"
        [title]="handRaised ? 'Lower hand' : 'Raise hand'"
      >
        <i class="bi bi-hand-index-thumb-fill"></i>
        <span class="meet-ctrl-label">{{ handRaised ? 'Lower' : 'Hand' }}</span>
      </button>

      <!-- Chat -->
      <button
        class="meet-ctrl-btn meet-ctrl-chat-btn"
        [class.meet-ctrl-active]="chatOpen"
        (click)="toggleChat()"
        title="Chat"
      >
        <span class="chat-btn-inner">
          <i class="bi bi-chat-fill"></i>
          <span class="chat-unread-badge" *ngIf="unreadMessages > 0">{{ unreadMessages > 9 ? '9+' : unreadMessages }}</span>
        </span>
        <span class="meet-ctrl-label">Chat</span>
      </button>

      <!-- Leave -->
      <button class="meet-ctrl-btn meet-ctrl-leave" (click)="leaveCall()" title="Leave call">
        <i class="bi bi-telephone-x-fill"></i>
        <span class="meet-ctrl-label">Leave</span>
      </button>
    </div>
  </div>

  <!-- Chat panel (slides in from right) -->
  <div class="chat-panel" [class.chat-panel--open]="chatOpen">
    <div class="chat-header">
      <span class="chat-header-title">In-call messages</span>
      <button class="chat-close-btn" (click)="toggleChat()" title="Close chat">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <div class="chat-messages">
      <div *ngIf="chatMessages.length === 0" class="chat-empty">
        <i class="bi bi-chat-dots"></i>
        <p>No messages yet</p>
      </div>
      <div
        *ngFor="let msg of chatMessages"
        class="chat-msg"
        [class.chat-msg--self]="msg.self"
      >
        <div class="chat-msg-meta">
          <span class="chat-msg-sender">{{ msg.self ? 'You' : msg.username }}</span>
          <span class="chat-msg-time">{{ msg.timestamp | date:'HH:mm' }}</span>
        </div>
        <div class="chat-msg-bubble">{{ msg.text }}</div>
      </div>
    </div>

    <div class="chat-input-row">
      <input
        class="chat-input"
        [(ngModel)]="chatInput"
        (keydown)="onChatKeyDown($event)"
        placeholder="Send a message..."
        maxlength="500"
        autocomplete="off"
      />
      <button class="chat-send-btn" (click)="sendMessage()" [disabled]="!chatInput.trim()">
        <i class="bi bi-send-fill"></i>
      </button>
    </div>
  </div>
</div>
